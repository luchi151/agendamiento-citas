{% extends 'citas/base_citas.html' %}

{% block title %}Agendar Cita - ATENEA{% endblock %}

{% block page_title %}Agendar Nueva Cita{% endblock %}

{% block extra_css %}
<style>
    #mensajeDatosEncontrados.datos-encontrados {
        background: #c8e6c9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 25px;
        display: none;
    }
    
    #mensajeDatosEncontrados.datos-encontrados.show {
        display: block;
        animation: slideDown 0.3s ease-out;
        background: #c8e6c9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 25px;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .loading-indicator {
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .loading-indicator i {
        font-size: 1.2rem;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .spin {
        animation: spin 1s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="info-box">
        <i class="bi bi-info-circle-fill"></i>
        <strong>Información importante:</strong> Todos los campos marcados con asterisco (*) son obligatorios. 
        Por favor completa toda la información para poder agendar tu cita.
    </div>
    
    <!-- Mensaje de datos encontrados - INICIA OCULTO -->
    <div class="datos-encontrados d-none" id="mensajeDatosEncontrados">
        <i class="bi bi-check-circle-fill"></i>
        <strong>¡Encontramos tus datos!</strong> Hemos cargado tu información previa. Puedes actualizarla si es necesario.
    </div>
    
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}
    
    <form method="post" id="formSolicitante">
        {% csrf_token %}
        
        <!-- Sección: Información Personal -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-person-fill"></i> Información Personal
            </h3>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.tipo_documento.id_for_label }}" class="form-label required">
                        {{ form.tipo_documento.label }}
                    </label>
                    {{ form.tipo_documento }}
                    {% if form.tipo_documento.errors %}
                        <div class="text-danger mt-1">{{ form.tipo_documento.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.numero_documento.id_for_label }}" class="form-label required">
                        {{ form.numero_documento.label }}
                    </label>
                    {{ form.numero_documento }}
                    <span class="loading-indicator" id="loadingIndicator" style="display: none;">
                        <i class="bi bi-arrow-repeat spin text-primary"></i>
                        <small class="text-muted">Buscando datos...</small>
                    </span>
                    {% if form.numero_documento.errors %}
                        <div class="text-danger mt-1">{{ form.numero_documento.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.nombre.id_for_label }}" class="form-label required">
                        {{ form.nombre.label }}
                    </label>
                    {{ form.nombre }}
                    {% if form.nombre.errors %}
                        <div class="text-danger mt-1">{{ form.nombre.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.apellido.id_for_label }}" class="form-label required">
                        {{ form.apellido.label }}
                    </label>
                    {{ form.apellido }}
                    {% if form.apellido.errors %}
                        <div class="text-danger mt-1">{{ form.apellido.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sección: Información de Contacto -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-telephone-fill"></i> Información de Contacto
            </h3>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.celular.id_for_label }}" class="form-label required">
                        {{ form.celular.label }}
                    </label>
                    {{ form.celular }}
                    {% if form.celular.errors %}
                        <div class="text-danger mt-1">{{ form.celular.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.correo_electronico.id_for_label }}" class="form-label required">
                        {{ form.correo_electronico.label }}
                    </label>
                    {{ form.correo_electronico }}
                    {% if form.correo_electronico.errors %}
                        <div class="text-danger mt-1">{{ form.correo_electronico.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sección: Datos Demográficos -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-people-fill"></i> Datos Demográficos
            </h3>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.sexo.id_for_label }}" class="form-label required">
                        {{ form.sexo.label }}
                    </label>
                    {{ form.sexo }}
                    {% if form.sexo.errors %}
                        <div class="text-danger mt-1">{{ form.sexo.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="{{ form.genero.id_for_label }}" class="form-label required">
                        {{ form.genero.label }}
                    </label>
                    {{ form.genero }}
                    {% if form.genero.errors %}
                        <div class="text-danger mt-1">{{ form.genero.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 mb-3">
                    <label for="{{ form.orientacion_sexual.id_for_label }}" class="form-label required">
                        {{ form.orientacion_sexual.label }}
                    </label>
                    {{ form.orientacion_sexual }}
                    {% if form.orientacion_sexual.errors %}
                        <div class="text-danger mt-1">{{ form.orientacion_sexual.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.rango_edad.id_for_label }}" class="form-label required">
                        {{ form.rango_edad.label }}
                    </label>
                    {{ form.rango_edad }}
                    {% if form.rango_edad.errors %}
                        <div class="text-danger mt-1">{{ form.rango_edad.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.nivel_educativo.id_for_label }}" class="form-label required">
                        {{ form.nivel_educativo.label }}
                    </label>
                    {{ form.nivel_educativo }}
                    {% if form.nivel_educativo.errors %}
                        <div class="text-danger mt-1">{{ form.nivel_educativo.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sección: Caracterización -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-grid-fill"></i> Caracterización
            </h3>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.grupo_etnico.id_for_label }}" class="form-label required">
                        {{ form.grupo_etnico.label }}
                    </label>
                    {{ form.grupo_etnico }}
                    {% if form.grupo_etnico.errors %}
                        <div class="text-danger mt-1">{{ form.grupo_etnico.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.grupo_poblacional.id_for_label }}" class="form-label required">
                        {{ form.grupo_poblacional.label }}
                    </label>
                    {{ form.grupo_poblacional }}
                    {% if form.grupo_poblacional.errors %}
                        <div class="text-danger mt-1">{{ form.grupo_poblacional.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.estrato_socioeconomico.id_for_label }}" class="form-label required">
                        {{ form.estrato_socioeconomico.label }}
                    </label>
                    {{ form.estrato_socioeconomico }}
                    {% if form.estrato_socioeconomico.errors %}
                        <div class="text-danger mt-1">{{ form.estrato_socioeconomico.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.localidad.id_for_label }}" class="form-label required">
                        {{ form.localidad.label }}
                    </label>
                    {{ form.localidad }}
                    {% if form.localidad.errors %}
                        <div class="text-danger mt-1">{{ form.localidad.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sección: Información Adicional -->
        <div class="form-section">
            <h3 class="section-title">
                <i class="bi bi-info-square-fill"></i> Información Adicional
            </h3>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.calidad_comunicacion.id_for_label }}" class="form-label required">
                        {{ form.calidad_comunicacion.label }}
                    </label>
                    {{ form.calidad_comunicacion }}
                    {% if form.calidad_comunicacion.errors %}
                        <div class="text-danger mt-1">{{ form.calidad_comunicacion.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.tiene_discapacidad.id_for_label }}" class="form-label required">
                        {{ form.tiene_discapacidad.label }}
                    </label>
                    {{ form.tiene_discapacidad }}
                    {% if form.tiene_discapacidad.errors %}
                        <div class="text-danger mt-1">{{ form.tiene_discapacidad.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="{{ form.tipo_discapacidad.id_for_label }}" class="form-label">
                        {{ form.tipo_discapacidad.label }}
                    </label>
                    {{ form.tipo_discapacidad }}
                    {% if form.tipo_discapacidad.errors %}
                        <div class="text-danger mt-1">{{ form.tipo_discapacidad.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Botones -->
        <div class="d-flex justify-content-center gap-3 mt-4">
            <a href="{% url 'home' %}" class="btn btn-volver">
                <i class="bi bi-arrow-left"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-siguiente">
                Continuar <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mensajeDatosEncontrados = document.getElementById('mensajeDatosEncontrados');
        const tipoDocumentoSelect = document.querySelector('[name="tipo_documento"]');
        const numeroDocumentoInput = document.querySelector('[name="numero_documento"]');
        
        let yaBusco = false;
        let timeoutId = null;
        
        async function buscarDatosSolicitante() {
            const tipoDocumento = tipoDocumentoSelect.value;
            const numeroDocumento = numeroDocumentoInput.value.trim();
            
            if (!tipoDocumento || !numeroDocumento) {
                return;
            }
            
            if (yaBusco) {
                return;
            }
            
            yaBusco = true;
            loadingIndicator.style.display = 'flex';
            mensajeDatosEncontrados.classList.remove('show');
            
            try {
                const response = await fetch(
                    `/citas/api/buscar-solicitante/?tipo_documento=${encodeURIComponent(tipoDocumento)}&numero_documento=${encodeURIComponent(numeroDocumento)}`
                );
                
                const data = await response.json();
                
                if (data.success && data.encontrado) {
                    llenarFormulario(data.datos);
                    mensajeDatosEncontrados.classList.remove('d-none');
                    mensajeDatosEncontrados.classList.add('show');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (data.success && !data.encontrado) {
                    mensajeDatosEncontrados.classList.remove('show');
                    mensajeDatosEncontrados.classList.add('d-none');
                    console.log('No se encontraron datos previos para este documento');
                } else {
                    console.error('Error al buscar datos:', data);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        numeroDocumentoInput.addEventListener('blur', function() {
            timeoutId = setTimeout(function() {
                buscarDatosSolicitante();
            }, 300);
        });
        
        tipoDocumentoSelect.addEventListener('change', function() {
            if (numeroDocumentoInput.value.trim()) {
                yaBusco = false;
                buscarDatosSolicitante();
            }
        });
        
        numeroDocumentoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                yaBusco = false;
                buscarDatosSolicitante();
            }
        });
        
        numeroDocumentoInput.addEventListener('input', function() {
            yaBusco = false;
            mensajeDatosEncontrados.classList.remove('show');
        });
        
        function llenarFormulario(datos) {
            document.querySelector('[name="nombre"]').value = datos.nombre || '';
            document.querySelector('[name="apellido"]').value = datos.apellido || '';
            document.querySelector('[name="celular"]').value = datos.celular || '';
            document.querySelector('[name="correo_electronico"]').value = datos.correo_electronico || '';
            document.querySelector('[name="tipo_discapacidad"]').value = datos.tipo_discapacidad || '';
            
            setSelectValue('[name="sexo"]', datos.sexo);
            setSelectValue('[name="genero"]', datos.genero);
            setSelectValue('[name="orientacion_sexual"]', datos.orientacion_sexual);
            setSelectValue('[name="rango_edad"]', datos.rango_edad);
            setSelectValue('[name="nivel_educativo"]', datos.nivel_educativo);
            setSelectValue('[name="grupo_etnico"]', datos.grupo_etnico);
            setSelectValue('[name="grupo_poblacional"]', datos.grupo_poblacional);
            setSelectValue('[name="estrato_socioeconomico"]', datos.estrato_socioeconomico);
            setSelectValue('[name="localidad"]', datos.localidad);
            setSelectValue('[name="calidad_comunicacion"]', datos.calidad_comunicacion);
            
            const tieneDiscapacidadSelect = document.querySelector('[name="tiene_discapacidad"]');
            if (tieneDiscapacidadSelect) {
                tieneDiscapacidadSelect.value = datos.tiene_discapacidad ? 'True' : 'False';
                toggleTipoDiscapacidad();
            }
        }
        
        function setSelectValue(selector, value) {
            const select = document.querySelector(selector);
            if (select && value) {
                select.value = value;
            }
        }
        
        const tieneDiscapacidadSelect = document.querySelector('[name="tiene_discapacidad"]');
        const tipoDiscapacidadDiv = document.querySelector('[name="tipo_discapacidad"]').closest('.mb-3');
        
        function toggleTipoDiscapacidad() {
            if (tieneDiscapacidadSelect.value === 'True') {
                tipoDiscapacidadDiv.style.display = 'block';
            } else {
                tipoDiscapacidadDiv.style.display = 'none';
            }
        }
        
        tieneDiscapacidadSelect.addEventListener('change', toggleTipoDiscapacidad);
        toggleTipoDiscapacidad();
    });
</script>
{% endblock %}